
# DAG Recently

## 引言
时间来到了2019年, 区块链的扩容(scalability)问题因直接影响到用户体验和商业落地尤为突出. 可喜的是, 新出的技术会立足于更本质的问题, 力求在不牺牲某一技术指标的区块能根本解决区块链的扩容问题.  主流的扩容方案包括: DAG, 分片, 链下, 多级区块. 其中, DAG技术是唯一基于经典区块链设定的链上扩容技术, 在安全性, 确认速度和扩容能力都有较好地平衡, 在近期受到了产业界还是学术届都有较大的关注. 

## Transactional DAG
目前已经成功运行的三个DAG项目IOTA, OByte和NANO有个共同的特点就是账本结构每个节点都是一笔交易, 而且都没有用工作量证明参与共识. 造成许多用户甚至DAG项目的开发人员都认为DAG项目就是无区块, 无PoW. 事实上这是一种误读, 后面的Block DAG会介绍DAG的本质是什么以及知名的Block DAG的协议和项目.  目前我们姑且给无区块, 无PoW的DAG起一个狭义的定义 Transactional DAG

### IOTA
IOTA 的DAG协议叫做tangle也特指tangle协议的数据结构. Tangle无交易手续费, 通过发布交易必须确认两笔待确认的交易来激励用户去进行利他行为. 因此, 并没有挖矿的存在的必要, 当然也没有区块存在的必要. 所以tangle中每个节点都是交易, 这类DAG 也称作 Transactional DAG. 为了防止女巫攻击, IOTA采用的是执行一个难度较小的工作量证明. IOTA的共识采用MCMC(), 通过统计从叶子交易随机游走到指定交易的概率, 估算出该交易被全网节点确认的概率, 即置信度, 来确认交易. 

Tangle 协议本身是完全去中心化的,但是由于无交易费, 没有专业矿工去参与确认交易, 造成交易量不是很大. 此外, 难度较小的PoW相对于ASIC矿机来说, 抵抗女巫攻击的能力有限. 所以算力强大的专业矿池, 可以用较低成本的算力去实施双花攻击. 所以目前IOTA引入了一个中心化的节点Coordinator, 来监督网络的共识. 不过官方承诺等到交易量比较活跃了, 会取消掉coordinator的限制, 拭目以待.

### OByte
OByte, 也就是之前的ByteBall, 也是transactional DAG, 即账本中每个节点都是一笔交易. OByte 率先引入了基于主链的共识机制. 主链是指从创世交易延伸到叶子交易的唯一一条路径. 非主链的交易由于与主链的交易必然存在引用或被引用的关系, 结合DAG图本身的拓扑排序以及极端情况的冲突解决机制, 比如说比hash值大小, 可以确认任意两个交易的顺序, 从而解决双花.

OByte 因实现逻辑简单清晰, 备受行业青睐, 给许多知名DAG项目提供了较大的参考价值. OByte的不足还在于主链的顺序是12个权威节点即见证人之间通过类PBFT共识来确定, 去中心化程度有待提高. 其次, OByte并没有达到理想DAG项目应有的吞吐指标, 普遍认为是其低效的SQL账本查询机制导致, 期待今后有更高效的实现.

### NANO
NANO, 前身叫RaiBlocks, 提出了BlockLattice的账本结构. NANO 每个账户都有一条只有该账户才有操作权限的账户链. NANO 将交易分成发送和接收两个过程, 分别对应发送区块和接收区块来完成这两个过程. 发送一笔交易时, 用户会生成一个发送区块写入到自己的账户链上, 此时该用户的余额已经减少. 直到接收者在自己的账户链上生成接收区块. 值得注意的是由于在接近的时间内有多个发送交易发送到同一个账户, 彼此之间的顺序由于网络延迟其实很难确定, 所以接收区块同时也负责确定这些发送交易的先后顺序. 

NANO的发送交易都会包含账户链上最新区块的引用, 如果存在多个交易引用同一个区块, 由于只有账户所有者才有生成发送交易的权限, 所以这些交易即为双花交易. NANO通过DPOS(Delegated-Proof-of-Stake)来解决双花. 得到大多数票数的交易保留, 其他的丢弃. 有意思的是账户链在创建的时候,必须要指定一个代理人. 这样可以避免投票不被代理的情况. 

由于NANO的共识机制还是DPOS, 仍然是一种偏中心化的解决方案.

### Avalance
Avanlance是一个基于弱稳态的DAG协议. 这个弱稳态可以理解为, 类似于原子核周围的电子的能量级. 一般的情况下, 电子接受少量的能量并不会从低能量级跃迁到高能量级, 保持相对的稳定. 但是吸收的能量到一定程度后, 并跃迁至高能量级达到下一个稳定的状态. Avanlanche的也有类似于SPECTRE的投票机制, 一旦发现冲突的交易, 会统计网络中的投票情况, 也有类似于SPECTRE的投票放大的机制. 周边如果某一方占优势, 自己会倒向这一方, 同时自己的倒向会增强该方的势力, 会加速影响其他的节点.

Avalanche 目前存在的问题是没有明确说怎么解决女巫攻击的问题, 因为理论上可以伪造大量的节点, 影响投票结果. 所以, 有人认为Avalanche是基于联盟链的协议, 因为联盟链的节点身份是已知的, 无法伪造. 
目前基于Avalanche实现的项目有Perlin, Perlin宣称已经解决了女巫攻击的问题.

## Block DAG系列
Block DAG, 顾名思义就是账本的每一个节点是区块. 用账本的节点是区块还是交易本身并不严谨, 因为交易也可以看作是交易数为一的区块. 所以Block DAG代表的是一种完全不同的DAG模型, 也是一种狭义的定义.
Block DAG要解决的其实是区块链的孤块率的问题, 即让区块淘汰并丢弃的区块也能贡献吞吐量. 比特币扩容, 最直观的思路就是提高出块率或者增加区块大小. 中本聪当然也会想到但是却没有这么做, 是因为这两者都会增加分叉率, 在比特币的最长链的竞争模型下, 高分叉率代表推翻最长分叉所需算力可能远不需要50%, 所以比特币是处于安全的考虑而通过牺牲扩容能力. 而Block DAG就是为了解决如何在不牺牲安全性的前提下提高扩容能力. 由于Block DAG是在经典的比特币的基础上进行的最简单和直观的扩容方案, 几乎没有改变比特币的任何设定, 即全节点通过算力自由参与而实现的完全去中心化, 50%安全性保证而区别于分片分层等其他扩容方案, 我们称之经典区块链设定. 而这种满足经典区块链设定的DAG协议统称为Block DAG协议

### Conflux
Conflux 在GHOST协议的基础上将BlockTree 扩展成为BlockDAG, 从而极大地提高了交易地吞吐量. 在GHOST协议中, 通过最重子树的算法, 可以唯一确定一条由至少50%算力保证的唯一的区块链, 成为最重链. 本质上, 在不考虑安全性的情况下, 比特币的最长链规则和GHOST的最重链规则在同样的出块率的情况下, 吞吐量是一样的. 因为除最重链之外的区块内的交易不会写入账本. 

Conflux的思路是在新生成一个区块时, 通过最GHOST的最重链规则, 确定其中一个引用的区块为父亲区块. 这样Block DAG 就退化称一棵树. 然后在此基础上执行GHOST协议确认最终链, 即为Pivot-Chain. Pivot-Chain, 类似于Inclusive协议和OByte的主链, 以此作为参考可以确定所有区块的顺序. 从而可以实现一层的基于状态的智能合约, 也是Conflux的一大亮点.

Conflux支持交易线性排序带来的影响是理论确认速度相较于SPECTRE会比较慢, 但是官方认为在实际运行中不会有太大影响.

值得注意的是, Conflux的论文附上一个对PHANTOM协议的攻击, 目前已经在最新的PHANTOM的协议中修复, 说明CONFLUX团队对DAGLabs的相关技术有较深的研究. 不过据我们了解该BUG是PHANTOM的一个参考实现, PHANTOM协议本身的思路并没有该问题.

### SPECTRE
SPECTRE是一个支持快速确认的Block DAG协议. SPECTRE不支持交易的全序列, 所以无法实现基于状态的智能合约. SPECTRE的共识算法是一个投票算法, 一旦发现有冲突交易, 则包含冲突交易的区块作为候选人接受所有区块的投票, 每个区块一票. SPECTRE的投票有放大效应, 比如说区块会跟随其过去集中票数的大多数投票, 所以收敛速度很快, 一点细微的票数差异就能造成优胜者的巨大优势. SPECTRE只能保证诚实区块的快速确认, 对于发布时间接近的两个冲突区块, SPECTRE的确认时间是不确定的, 这就是SPECTRE提出的弱活性的概念, 即不能保证所有区块都能在某个合理的时间内得到最终确认. 但是SPECTRE基于交易系统的共识协议, 在交易系统中, 只有作恶者才能制造双花交易, 也就是说, 双花交易并不会对诚实区块造成太大的影响. 此外, 制造双花交易对于时间的控制非常苛刻, 一般情况下很难造成攻击. 所以, SPECTRE认为这个弱活性的问题在实际项目中是可以接受的.

### PHANTOM/GHOSTDAG
PHANTOM是为了解决SPECTRE协议无法支持交易线性排序的问题而新推出的BlockDAG协议, 也是第一个支持交易线性排序的Block DAG协议. PHANTOM/GHOSTDAG的思想是观察在一个特定网络中, 如果设定好相应的技术指标, 比如说出块率, 绝大多数区块传播到全网的时延, 以及可承受的风险等级即多大的概率有可能出现异常, 比如网络故障造成无法在区块之间形成良好的连通性. 这里的连通性是指在正常情况下, 区块无法直接通过拓扑排序定序的区块的最大的数量. 直观上理解, 就是某个区块生成时, 同时最多有多少个区块也同时被其他矿工挖出. 或者简单理解为并发产生的区块数也可以. 假设这个数字为k, 如果一个DAG的子图满足任意区块的连通性都为k, 则该子图为k-cluster. 其中DAG中最大的k-cluster称为蓝色集, 非蓝色集的区块认为是恶意的, 称为红色集. 

PHANTOM和GHOSTDAG协议的区别是PHANTOM是严格地去找最大的k-cluster, 但是找k-cluster是NP问题, 效率很低. 所以有了通过贪婪算法寻找近似最大蓝色集的GHOSTDAG算法, 由于PHANTOM算法不具备工程实现上的可行性, 一般我们只关注GHOSTDAG算法, 没有明确指出的情况下, 一般说PHANTOM其实指的也是GHOSTDAG.

PHANTOM除了支持交易线性排序之外, 也解决了SPECTRE的弱活性的问题, 目前的问题在于PHANTOM的蓝色集比较难以稳定, 确认时间会比SPCTRE长很多.

### HLC
HLC是基于GHOSTDAG和SPECTRE双层共识的BlockDAG项目. HLC 公链的核心是价值交换, 所以在一层智能合约和交易确认速度的取舍上优先选择对价值交换体验更加重要的确认速度, 所以选择SPECTRE作为基础共识协议.同时为了解决SPECTRE协议的弱活性问题, 在SPECTRE的基础上引入了GHOSTDAG协议, 确保用户体验的一致性. 此外, 引入PHANTOM协议还有重要的考虑是在区块的奖励机制上需要用到PHANTOM的线性排序能力, 由于区块的奖励对于确认时间要求不高, 所以PHANTOM相对较低的确认速度不会造成影响.